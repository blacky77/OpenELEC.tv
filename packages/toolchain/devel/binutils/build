#!/bin/sh

. config/options $1

$SCRIPTS/install ccache
$SCRIPTS/install linux-headers
$SCRIPTS/build gmp
$SCRIPTS/build mpfr
$SCRIPTS/build ppl
$SCRIPTS/build cloog-ppl
$SCRIPTS/build libelf

if [ $TARGET_ARCH = "x86_64" ]; then
  WITH_64B_BFD="--enable-64-bit-bfd"
fi

setup_toolchain host

cd $PKG_BUILD
mkdir -p objdir
cd objdir
../configure --host=$HOST_NAME \
             --build=$HOST_NAME \
             --target=$TARGET_NAME \
             --prefix=$ROOT/$TOOLCHAIN \
             --with-sysroot=$SYSROOT_PREFIX \
             --with-gmp=$ROOT/$TOOLCHAIN \
             --with-mpfr=$ROOT/$TOOLCHAIN \
             --with-ppl=$ROOT/$TOOLCHAIN \
             --with-cloog=$ROOT/$TOOLCHAIN \
             --with-libelf=$ROOT/$TOOLCHAIN \
             --enable-werror \
             --disable-multilib \
             --disable-libada \
             --disable-libssp \
             --enable-version-specific-runtime-libs \
             $WITH_64B_BFD \
             --disable-nls

make configure-host
make

cp -v ../include/libiberty.h $SYSROOT_PREFIX/usr/include

make install

# add a link named 'strip' in the toolchain, it overrides the host
# 'strip' with `install -s`
#  ln -s $TARGET_NAME-strip $ROOT/$TOOLCHAIN/bin/strip

