#!/bin/sh

. config/options $1

LINUX=`ls -d $PKG_BUILD`

if [ -f $PROJECT_DIR/$PROJECT/$1/$1.$TARGET_ARCH.conf ]; then
  KERNEL_CFG_FILE=$PROJECT_DIR/$PROJECT/$1/$1.$TARGET_ARCH.conf
else
  KERNEL_CFG_FILE=$PKG_DIR/config/$1.$TARGET_ARCH.conf
fi

sed -i -e "s|^HOSTCC[[:space:]]*=.*$|HOSTCC = $HOST_CC|" \
       -e "s|^HOSTCXX[[:space:]]*=.*$|HOSTCXX = $HOST_CXX|" \
       -e "s|^ARCH[[:space:]]*?=.*$|ARCH = $TARGET_ARCH|" \
       -e "s|^CROSS_COMPILE[[:space:]]*?=.*$|CROSS_COMPILE = $TARGET_PREFIX|" \
       $LINUX/Makefile

cp $KERNEL_CFG_FILE $LINUX/.config
sed -i -e "s|^CONFIG_INITRAMFS_SOURCE=.*$|CONFIG_INITRAMFS_SOURCE=\"$ROOT/$PKG_DIR/config/initramfs\"|" \
  $LINUX/.config

if [ "$DEVTOOLS" = yes ]; then
  echo "CONFIG_FRAMEBUFFER_CONSOLE=y" >> $LINUX/.config
  echo "CONFIG_FRAMEBUFFER_CONSOLE_DETECT_PRIMARY=y" >> $LINUX/.config
  echo "CONFIG_FRAMEBUFFER_CONSOLE_ROTATION=n" >> $LINUX/.config
  echo "CONFIG_FONTS=n" >> $LINUX/.config
fi

if [ "$PPP_DAEMON" = yes ]; then
 echo  "CONFIG_PPP=m" >> $LINUX/.config
 echo  "CONFIG_PPP_MULTILINK=n" >> $LINUX/.config
 echo  "CONFIG_PPP_FILTER=n" >> $LINUX/.config
 echo  "CONFIG_PPP_ASYNC=m" >>  $LINUX/.config
 echo  "CONFIG_PPP_SYNC_TTY=m" >> $LINUX/.config
 echo  "CONFIG_PPP_DEFLATE=n" >> $LINUX/.config
 echo   "CONFIG_PPP_BSDCOMP=n" >>  $LINUX/.config
 echo  "CONFIG_PPP_MPPE=n" >> $LINUX/.config
 echo  "CONFIG_PPPOE=y" >> $LINUX/.config
 echo  "CONFIG_PPPOL2TP=n" >> $LINUX/.config
fi 

# copy some extra firmware to linux tree
  cp -R $PKG_DIR/firmware/* $LINUX/firmware

make -C $LINUX oldconfig
